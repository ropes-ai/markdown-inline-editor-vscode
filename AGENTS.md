## Shared Context

**Tech Stack**
- TypeScript
- VS Code API
- [remark](https://github.com/remarkjs/remark) (Markdown parser)
- Jest for tests

**Project Structure**
- [`src/`](src/) – source code
    - [`extension.ts`](src/extension.ts) – activation and extension entrypoint
    - [`config.ts`](src/config.ts) – centralized configuration access
    - [`diff-context.ts`](src/diff-context.ts) – unified diff view detection and policy
    - [`link-targets.ts`](src/link-targets.ts) – unified link/image URL resolution
    - [`markdown-parse-cache.ts`](src/markdown-parse-cache.ts) – shared parsing and caching service
    - [`parser.ts`](src/parser.ts) – parses markdown to decoration ranges
    - [`parser-remark.ts`](src/parser-remark.ts) – remark dependency helper
    - [`decorations.ts`](src/decorations.ts) – decoration types/factories
    - [`decorator.ts`](src/decorator.ts) – decoration orchestration (uses helper modules)
    - [`decorator/decoration-type-registry.ts`](src/decorator/decoration-type-registry.ts) – decoration type lifecycle management
    - [`decorator/visibility-model.ts`](src/decorator/visibility-model.ts) – 3-state filtering logic (Rendered/Ghost/Raw)
    - [`decorator/checkbox-toggle.ts`](src/decorator/checkbox-toggle.ts) – checkbox click handling
    - [`decorator/decoration-categories.ts`](src/decorator/decoration-categories.ts) – decoration type categorization
    - [`link-provider.ts`](src/link-provider.ts) – clickable link provider for markdown documents
    - [`link-hover-provider.ts`](src/link-hover-provider.ts) – hover provider for link URLs
    - [`image-hover-provider.ts`](src/image-hover-provider.ts) – hover provider for image previews
    - [`link-click-handler.ts`](src/link-click-handler.ts) – single-click navigation handler
    - [`position-mapping.ts`](src/position-mapping.ts) – position mapping utilities (CRLF/LF normalization)
    - [`parser/__tests__/`](src/parser/__tests__/ ) – parser tests
    - [`markdown-parse-cache/__tests__/`](src/markdown-parse-cache/__tests__/ ) – parse cache tests
    - [`diff-context/__tests__/`](src/diff-context/__tests__/ ) – diff context tests
    - [`link-targets/__tests__/`](src/link-targets/__tests__/ ) – link target resolution tests
    - [`link-provider/__tests__/`](src/link-provider/__tests__/ ) – link provider tests
    - [`image-hover-provider/__tests__/`](src/image-hover-provider/__tests__/ ) – image hover provider tests
    - [`link-hover-provider/__tests__/`](src/link-hover-provider/__tests__/ ) – link hover provider tests
    - [`link-click-handler/__tests__/`](src/link-click-handler/__tests__/ ) – click handler tests
- [`dist/`](dist/) – compiled output (do not edit)
- [`docs/`](docs/) – documentation, optimization notes
- [`scripts/`](scripts/) – build and release automation scripts
  - [`release.js`](scripts/release.js) – automated release script (version detection, changelog generation, tagging)
  - [`validate-feature-outline.js`](scripts/validate-feature-outline.js) – validates feature file structure
- [`cliff.toml`](cliff.toml) – git-cliff configuration for automated changelog generation from conventional commits
- [`CHANGELOG.md`](CHANGELOG.md) – project changelog (auto-generated by release script)
- [`assets/`](assets/) – icons and static files

**Key Commands**
- Compile: `npm run compile` (TypeScript compilation only)
- Build: `npm run build` (compile + bundle + package for release)
- Clean: `npm run clean`
- Test: `npm test`
- Test watch: `npm run test:watch`
- Coverage: `npm run test:coverage`
- Lint: `npm run lint`
- Lint docs: `npm run lint:docs` (validates feature file structure)
- Package: `npm run package`
- Release: `node scripts/release.js` (automated release - see release section below)


## Operational Rules

**Boundaries**
- Only modify code in `/src/`, ignore `/dist/` and generated files
- Never parse whole document on selection change (use cache)
- Test *all* changes, maintain/expand test suites in `*/__tests__/` directories
- Handle large files and malformed markdown gracefully
- Maintain test coverage: currently 57+ passing tests across parser, hover providers, and click handler

**Git Workflow**
- Use feature branches per focus area (parser, decoration, etc.)
- PRs must be focused and pass all CI (lint, test, typecheck)
- Reference any related issues or PRs
- **All commits must follow Conventional Commits specification**
  - Format: `<type>(<scope>): <description>`
  - Types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `chore`
  - Examples:
    - `feat(parser): add support for task lists`
    - `fix(decorator): cache decorations on selection change`
    - `perf(parser): optimize ancestor chain building`
    - `docs: update performance improvements roadmap`

**Code Style**
- TypeScript strict mode: use interfaces/unions, avoid `any`
- Naming: PascalCase for classes, camelCase for functions, kebab-case for tests
- Add clear JSDoc to public methods and complex logic
- Use meaningful and descriptive names

**Definition of Done**
- Code builds and passes all tests/coverage
- All relevant docs or tests updated
- Contribution aligns with project structure and style

**Releasing a Version (Conventional Commits & SemVer)**

## How to Create a Release

**Primary Method: Automated Release Script**

The project uses an automated release script that handles version detection, changelog generation, and git operations. This is the recommended approach.

### Step-by-Step Release Process

1. **Ensure you're ready:**
   - All changes are committed and pushed
   - You're on the `main` branch
   - Working tree is clean (no uncommitted changes)
   - All commits follow [Conventional Commits](https://www.conventionalcommits.org/) format

2. **Run the release script:**
   ```bash
   node scripts/release.js
   ```

3. **What the script does automatically:**
   - ✅ Validates environment (checks branch and working tree)
   - ✅ Runs validation checks:
     - `npm run lint:docs` - Validates feature file structure
     - `npm test` - Runs test suite
     - `npm run build` - Builds the extension
   - ✅ Determines next version using `git-cliff`:
     - Analyzes commits since last tag
     - Applies SemVer rules:
       - `feat:` → **minor** bump (1.2.3 → 1.3.0)
       - `fix:` → **patch** bump (1.2.3 → 1.2.4)
       - `BREAKING CHANGE:` → **major** bump (1.2.3 → 2.0.0)
   - ✅ Generates `CHANGELOG.md`:
     - Parses commit messages using `cliff.toml` configuration
     - Groups by type: `Added`, `Changed`, `Fixed`
     - Follows [Keep a Changelog](https://keepachangelog.com/) format
     - Excludes release commits automatically
   - ✅ Updates `package.json` and `package-lock.json` version
   - ✅ Commits changes with message: `chore(release): vX.Y.Z`
   - ✅ Creates git tag: `vX.Y.Z`

4. **Push the release:**
   After the script completes successfully, push the changes and tag:
   ```bash
   git push origin main --follow-tags
   ```
   This pushes both the commit and the tag in one command.

5. **CI/CD automatically publishes:**
   - The GitHub Actions workflow (`.github/workflows/ci.yaml`) detects tags starting with `v`
   - Automatically publishes to VS Code Marketplace and OpenVSX
   - No manual publishing steps required

### Requirements

- **git-cliff**: Automatically downloaded via `npx` if not installed. For better performance:
  ```bash
  npm install -g git-cliff
  ```
- **Conventional Commits**: All commits must follow the specification for automatic version detection

### Troubleshooting

- **Script fails with "git-cliff not available"**: Install globally with `npm install -g git-cliff`
- **Version detection fails**: Ensure you have conventional commits since the last tag
- **Validation fails**: Fix the failing checks (lint errors, test failures, or build issues) before releasing
- **Need to undo**: The script provides undo instructions, typically:
  ```bash
  git reset --hard HEAD~1
  git tag -d vX.Y.Z
  ```

### Alternative Methods

**Makefile-based Release** (requires manual version specification):
```bash
make release-prep              # Validate and check git status
make release VERSION=1.10.0    # Interactive release (updates version, prompts for CHANGELOG)
make release-commit VERSION=1.10.0  # Commit and tag (after CHANGELOG is updated)
```

**Manual Release** (not recommended - use automated script instead):
Only use if the automated script cannot be used. Follow the same steps but manually:
1. Determine version bump from commits
2. Run validation checks
3. Update `package.json` version
4. Manually update `CHANGELOG.md`
5. Commit, tag, and push

See `docs/release-generation.md` for more detailed documentation.